# AGENTS.md

## Proposito del repositorio
{{project_description}}

## Stack tecnologico
{{#stacks}}
- {{.}}
{{/stacks}}

## Comandos canonicos
- Instalar dependencias: `{{commands.install}}`
{{#has_dev}}
- Ejecutar emuladores locales: `{{commands.dev}}`
{{/has_dev}}
- Desplegar a Firebase: `firebase deploy --only functions`
{{#has_build}}
- Compilar: `{{commands.build}}`
{{/has_build}}
{{#has_lint}}
- Lint: `{{commands.lint}}`
{{/has_lint}}
{{#has_tests}}
- Pruebas: `{{commands.test}}`
{{/has_tests}}

## Definicion de terminado
Antes de considerar una tarea completa:
{{#has_tests}}
- [ ] `{{commands.test}}` pasa sin errores
{{/has_tests}}
{{#has_lint}}
- [ ] `{{commands.lint}}` pasa sin errores
{{/has_lint}}
- [ ] Probado localmente con emuladores de Firebase
- [ ] No anadir dependencias nuevas sin confirmacion
- [ ] Revisar cuotas y limites de Firebase

## Estilo y convenciones
{{style_notes}}

### Funciones Firebase
- Funciones idempotentes (misma entrada = misma salida)
- Manejar arranques en frio: minimizar dependencias globales
- Usar `onCall` para funciones HTTPS callable, `onRequest` para endpoints REST
- Timeout configurado segun caso de uso (predeterminado 60s, max 540s)

## Variables de entorno
- Variables de configuracion en `.env` (local) y Firebase Config (produccion)
- Secrets en Google Secret Manager, accedidos via `functions.config()`
- NO hardcodear API keys, tokens, o credenciales

{{#has_tests}}
## Guia de pruebas
{{testing_notes}}

### Estrategia de pruebas
- Pruebas unitarias para logica de negocio (sin Firebase)
- Pruebas de integracion con emuladores de Firebase
- Mocking de Firebase Admin SDK cuando sea necesario
{{/has_tests}}

{{#isStandardOrFull}}
## Como trabajar con agentes de IA

### Formato de tareas
- Define objetivo, alcance y salida esperada desde el inicio.
- Incluye recursos de Firebase afectados (Functions, Firestore, Storage).
- Manten cambios minimos y deterministicos.
- Solicita pasos de validacion explicitos antes de cerrar la tarea.

### Solicitud de diffs y validacion
- Pide archivos cambiados y motivo por archivo.
- Pide registro de comandos usados para validacion local.
- Pide resultados de pruebas/emulador con resumen exito/fallo.
- Pide notas de impacto en seguridad al tocar rutas de auth o datos.

### Lista de entrega Firebase
- Confirma que los triggers de funciones sean correctos e intencionales.
- Confirma que supuestos de reintentos/idempotencia sean explicitos.
- Confirma que timeouts y uso de recursos sean razonables.
- Confirma que no haya secretos embebidos en codigo fuente.

## Definicion de terminado ampliada
- [ ] Alcance completo sin refactors no relacionados.
- [ ] Verificaciones en emulador o validacion local equivalente completadas.
- [ ] Sin valores marcadores en markdown generado.
- [ ] Docs y guias operativas actualizados por cambios de comportamiento.
- [ ] Compatibilidad hacia atras confirmada para consumidores existentes.

## Lista de depuracion
- Reproduce con emulador o fixture deterministico.
- Verifica variables de entorno y fuente de config de Firebase.
- Revisa deteccion de comandos y seccion de comandos generada.
- Valida tamano de salida y secciones obligatorias por perfil.
- Reejecuta pruebas enfocadas antes de suite completa.

## Estrategia de pruebas
- Prueba unitaria de logica de negocio pura fuera de wrappers de Firebase SDK.
- Usa pruebas de integracion con emulador para comportamiento de frontera.
- Manten aserciones estables y deterministicas.
{{#has_tests}}
- Manten referencias de comandos alineadas con `{{commands.test}}`.
{{/has_tests}}

## Haz / No hagas
### Haz
- Valida entrada y contexto auth en cada punto de entrada.
- Manten efectos secundarios de funciones explicitos.
- Documenta expectativas de deploy y rollback.
- Preserva comportamiento compact por defecto.

### No hagas
- No hardcodees ids de proyecto, keys o secretos.
- No dependas de estado global implicito entre invocaciones.
- No omitas validacion en triggers en background.
- No agrupes cambios no relacionados en un mismo patch.

## Plantilla de handoff del agente
### Campos obligatorios
- Objetivo: una frase que describa el estado final esperado.
- Alcance: archivos o carpetas exactas que pueden cambiar.
- Restricciones: lo que no debe cambiar.
- Validacion: comandos que prueban el cambio.
- Riesgos: incertidumbre conocida o items de seguimiento.

### Formato de actualizacion de estado
- Completado: items concretos finalizados.
- En progreso: paso activo actual.
- Siguiente: accion inmediata.
- Bloqueos: informacion faltante o dependencia externa.

### Lista de revision
- [ ] El diff por archivo es facil de seguir.
- [ ] Las pruebas cubren el comportamiento cambiado.
- [ ] La salida se mantiene deterministica.
- [ ] No hay cambios de comportamiento ocultos.
- [ ] El manejo de errores es explicito.
- [ ] La documentacion refleja el nuevo comportamiento.

### Reglas de escalamiento
- Escala cuando los requisitos entran en conflicto.
- Escala antes de agregar dependencias.
- Escala antes de tocar modulos no relacionados.
- Escala ante implicaciones de seguridad ambiguas.
{{/isStandardOrFull}}

{{#isFull}}
## Protocolo avanzado para agentes

### Clasificacion de riesgos
- Bajo: ajustes de texto en docs/templates.
- Medio: renderizado dependiente de perfil y limites de validacion.
- Alto: parseo de CLI, comandos de deploy y escrituras en filesystem.
- Cambios medio/alto requieren pruebas de regresion enfocadas.

### Lista de handoff para PR
- Entrega salida antes/despues para cada perfil afectado.
- Entrega comandos exactos de verificacion y resultados.
- Entrega notas de compatibilidad para workflows existentes.
- Entrega guia de riesgo residual y rollback.

### Flujo de triage de fallas
1. Reproduce con fixture y flag `--profile` explicito.
2. Aisla si la falla es detect/render/validate.
3. Verifica que el markdown generado incluya el conjunto de comandos requerido.
4. Aplica patch minimo y agrega cobertura de regresion.

### Notas de endurecimiento de CI
- Manten pruebas neutrales al OS para rutas y ejecucion.
- Usa invocacion de procesos sin shell en pruebas e2e.
- Evita aserciones dependientes del tiempo.
- Manten fixtures pequenos y deterministicos.

### Matriz de verificacion
| Capa | Verificacion | Evidencia |
|---|---|---|
| CLI | Parseo de argumentos | salida del comando |
| Deteccion | scripts/framework | resultado del fixture |
| Renderizado | secciones por perfil | vista previa markdown |
| Validacion | limites/marcadores | pruebas unitarias |
| E2E | comando dry-run | pruebas ok |

### Guia de rollback
1. Revierte primero bloques de template especificos por perfil.
2. Manten soporte de parser solo si es compatible hacia atras.
3. Reejecuta pruebas de perfil compact y e2e.
4. Reintroduce cambios en porciones mas pequenas.

### Protocolo de comunicacion
- Resume supuestos antes de codificar.
- Reporta archivos cambiados inmediatamente despues de cada edicion.
- Reporta comandos ejecutados y resultados.
- Reporta riesgos no resueltos antes del handoff.

### Auditoria post-merge
- Verifica que los ejemplos del README sigan funcionando como estan documentados.
- Verifica que SPEC y comportamiento sigan alineados.
- Verifica CI verde en al menos un runner de Windows.
- Verifica que la salida compact por defecto permanezca igual.
- Verifica que standard/full se mantengan dentro de limites configurados.

### Plantilla minima de reporte de falla
- Comando: comando exacto que falla
- Esperado: que deberia pasar
- Real: que paso
- Capa sospechosa: detect/render/validate/cli
- Fixture de reproduccion: ruta usada

### Puerta final de liberacion
- Confirma que los limites por perfil pasen el validador.
- Confirma que las validaciones de marcadores sigan estrictas.
- Confirma que la salida compact por defecto no cambie.
- Confirma que las docs coincidan con los flags implementados.
- Confirma suite de pruebas en verde en modo CI.
- Confirma que no haya archivos no relacionados modificados.
- Confirma que el markdown generado siga iniciando con # AGENTS.
- Confirma orden de perfiles full > standard > compact.
{{/isFull}}

## Seguridad
{{security_notes}}

### Especifico de Firebase
- Validar todos los inputs en funciones callable
- Usar Firebase Auth para autenticacion
- Implementar Security Rules en Firestore/Storage
- Nunca exponer Service Account keys en codigo

## Despliegue
- Desplegar staging: `firebase deploy --only functions --project staging`
- Desplegar produccion: `firebase deploy --only functions --project production`
- Rollback: `firebase functions:delete FUNCTION_NAME` + redeploy version anterior

---
*Generado por agents-md v{{generator_version}}*
