# AGENTS.md

## Proposito del repositorio
{{project_description}}

Este es un monorepo que contiene multiples paquetes y aplicaciones.

## Stack tecnologico
{{#stacks}}
- {{.}}
{{/stacks}}

## Estructura del monorepo
```
.
|-- apps/         # Aplicaciones desplegables
`-- packages/     # Paquetes compartidos/librerias
```

## Comandos canonicos
- Instalar dependencias: `{{commands.install}}`
{{#has_dev}}
- Ejecutar todos los dev servers: `{{commands.dev}}`
{{/has_dev}}
{{#has_build}}
- Compilar todos los paquetes: `{{commands.build}}`
{{/has_build}}
{{#has_lint}}
- Lint de todo el monorepo: `{{commands.lint}}`
{{/has_lint}}
{{#has_tests}}
- Pruebas de todo el monorepo: `{{commands.test}}`
{{/has_tests}}

### Comandos especificos de workspace
```bash
# Ejecutar comando en un workspace especifico
npm run dev --workspace=apps/web
pnpm --filter @myorg/api dev
yarn workspace @myorg/shared test
```

## Definicion de terminado
Antes de considerar una tarea completa:
{{#has_tests}}
- [ ] `{{commands.test}}` pasa en todos los paquetes afectados
{{/has_tests}}
{{#has_lint}}
- [ ] `{{commands.lint}}` pasa sin errores
{{/has_lint}}
{{#has_build}}
- [ ] `{{commands.build}}` completa sin errores
{{/has_build}}
- [ ] Cambios en packages/ no rompen apps/ que dependen de ellos
- [ ] Versiones de dependencias sincronizadas (usar workspaces)
- [ ] No anadir dependencias nuevas sin confirmacion

## Estilo y convenciones
{{style_notes}}

### Organizacion de codigo
- **apps/**: Aplicaciones completas (web, mobile, admin)
- **packages/**: Librerias compartidas, configuraciones, utilidades
- Naming: `@org/package-name` para scoped packages

### Dependencias
- Dependencias compartidas declaradas en root package.json
- Dependencias especificas en cada workspace
- Usar protocolo workspaces para dependencias internas: `"@myorg/shared": "workspace:*"`

{{#has_tests}}
## Guia de pruebas
{{testing_notes}}

### Estrategia de pruebas en monorepo
- Pruebas unitarias en cada package
- Pruebas de integracion para apps que consumen packages
- Usar cache de pruebas para evitar reejecuciones innecesarias
{{/has_tests}}

{{#isStandardOrFull}}
## Como trabajar con agentes de IA

### Formato de tareas
- Define workspaces objetivo y resultado esperado.
- Lista apps/packages afectados antes de implementar.
- Manten alcance aislado a nodos impactados del grafo.
- Pide verificacion explicita en workspaces afectados.

### Solicitud de diffs y validacion
- Pide resumen de cambios por workspace.
- Pide comandos exactos y filtros de workspace usados.
- Pide notas de impacto en el grafo de dependencias.
- Pide resultados de test/build para packages impactados.

### Lista de entrega monorepo
- Confirma que no haya rupturas de API entre workspaces no intencionales.
- Confirma que se respeten limites entre packages.
- Confirma que scripts de workspace sigan siendo canonicos.
- Confirma consistencia de lockfile y metadatos de workspace.

## Definicion de terminado ampliada
- [ ] Alcance completo solo en workspaces afectados.
- [ ] Build/pruebas pasan en nodos impactados del grafo.
- [ ] Sin valores marcadores en markdown generado.
- [ ] Apps consumidoras validadas para cambios en packages compartidos.
- [ ] Documentacion actualizada para cambios de comportamiento a nivel workspace.

## Lista de depuracion
- Reproduce primero con comando filtrado para un workspace.
- Valida deteccion de comandos de workspace desde scripts de root.
- Revisa salida generada para secciones obligatorias de monorepo.
- Confirma que se respeten limites de tamano por perfil.
- Reejecuta pruebas enfocadas antes de la suite completa del repo.

## Estrategia de pruebas
- Manten pruebas enfocadas con filtros de workspace cuando sea posible.
- Prioriza pruebas de regresion en packages compartidos.
- Usa fixtures deterministicos para comportamiento de comando/render.
{{#has_tests}}
- Manten referencias de comandos alineadas con `{{commands.test}}`.
{{/has_tests}}

## Haz / No hagas
### Haz
- Manten APIs de packages compartidos estables y explicitas.
- Aisla cambios por workspace cuando sea posible.
- Documenta impacto en grafo de dependencias.
- Preserva comportamiento compact por defecto.

### No hagas
- No cambies scripts de root sin motivo claro.
- No introduzcas acoplamiento oculto entre workspaces.
- No omitas validacion de consumidores impactados.
- No mezcles refactors de workspace no relacionados.

## Plantilla de handoff del agente
### Campos obligatorios
- Objetivo: una frase que describa el estado final esperado.
- Alcance: archivos o carpetas exactas que pueden cambiar.
- Restricciones: lo que no debe cambiar.
- Validacion: comandos que prueban el cambio.
- Riesgos: incertidumbre conocida o items de seguimiento.

### Formato de actualizacion de estado
- Completado: items concretos finalizados.
- En progreso: paso activo actual.
- Siguiente: accion inmediata.
- Bloqueos: informacion faltante o dependencia externa.

### Lista de revision
- [ ] El diff por archivo es facil de seguir.
- [ ] Las pruebas cubren el comportamiento cambiado.
- [ ] La salida se mantiene deterministica.
- [ ] No hay cambios de comportamiento ocultos.
- [ ] El manejo de errores es explicito.
- [ ] La documentacion refleja el nuevo comportamiento.

### Reglas de escalamiento
- Escala cuando los requisitos entran en conflicto.
- Escala antes de agregar dependencias.
- Escala antes de tocar modulos no relacionados.
- Escala ante implicaciones de seguridad ambiguas.
{{/isStandardOrFull}}

{{#isFull}}
## Protocolo avanzado para agentes

### Clasificacion de riesgos
- Bajo: cambios solo de docs/template.
- Medio: secciones condicionadas por perfil y rangos del validador.
- Alto: deteccion de scripts, render de comandos de workspace y escrituras de archivo.
- Exige pruebas enfocadas para cambios medio/alto.

### Lista de handoff para PR
- Incluye salida antes/despues para compact/standard/full.
- Incluye comandos de verificacion con filtros de workspace.
- Incluye declaracion de compatibilidad para comandos root existentes.
- Incluye notas de riesgo residual y rollback.

### Flujo de triage de fallas
1. Reproduce con fixture y perfil explicito.
2. Aisla la etapa detect/render/validate.
3. Verifica supuestos de extraccion de comandos de workspace.
4. Aplica patch minimo y agrega cobertura de regresion.

### Notas de endurecimiento de CI
- Manten comandos neutrales al shell cuando sea posible.
- Manten manejo de rutas neutral al OS.
- Manten pruebas deterministicas con fixtures fijos.
- Evita supuestos de orden inestables en aserciones.

### Matriz de verificacion
| Capa | Verificacion | Evidencia |
|---|---|---|
| CLI | Parseo de argumentos | salida del comando |
| Deteccion | scripts/framework | resultado del fixture |
| Renderizado | secciones por perfil | vista previa markdown |
| Validacion | limites/marcadores | pruebas unitarias |
| E2E | comando dry-run | pruebas ok |

### Guia de rollback
1. Revierte primero bloques de template especificos por perfil.
2. Manten soporte de parser solo si es compatible hacia atras.
3. Reejecuta pruebas de perfil compact y e2e.
4. Reintroduce cambios en porciones mas pequenas.

### Protocolo de comunicacion
- Resume supuestos antes de codificar.
- Reporta archivos cambiados inmediatamente despues de cada edicion.
- Reporta comandos ejecutados y resultados.
- Reporta riesgos no resueltos antes del handoff.

### Auditoria post-merge
- Verifica que los ejemplos del README sigan funcionando como estan documentados.
- Verifica que SPEC y comportamiento sigan alineados.
- Verifica CI verde en al menos un runner de Windows.
- Verifica que la salida compact por defecto permanezca igual.
- Verifica que standard/full se mantengan dentro de limites configurados.

### Plantilla minima de reporte de falla
- Comando: comando exacto que falla
- Esperado: que deberia pasar
- Real: que paso
- Capa sospechosa: detect/render/validate/cli
- Fixture de reproduccion: ruta usada

### Puerta final de liberacion
- Confirma que los limites por perfil pasen el validador.
- Confirma que las validaciones de marcadores sigan estrictas.
- Confirma que la salida compact por defecto no cambie.
- Confirma que las docs coincidan con los flags implementados.
- Confirma suite de pruebas en verde en modo CI.
- Confirma que no haya archivos no relacionados modificados.
- Confirma que el markdown generado siga iniciando con # AGENTS.
- Confirma orden de perfiles full > standard > compact.
{{/isFull}}

## Seguridad
{{security_notes}}

### Especifico de monorepo
- Revisar todas las dependencias transitivas (usar `npm audit` o `pnpm audit`)
- Lockfile sincronizado en root (yarn.lock, pnpm-lock.yaml)
- No exponer secrets entre workspaces innecesariamente

## Build y despliegue
- Build incremental: solo rebuilds de paquetes modificados
- Orden topologico: packages se compilan en orden de dependencias
- Cache de builds para optimizar CI/CD

---
*Generado por agents-md v{{generator_version}}*
